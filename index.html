<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash Royale Style Game - Versione Migliorata</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            color: white;
            overflow: hidden;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 100;
        }

        #game-screen {
            background: transparent;
            z-index: 1;
        }

        #start-screen {
            display: flex;
        }

        #end-screen {
            display: none;
        }

        h1 {
            color: #ffcc00;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-size: 3rem;
        }

        .player-input {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            width: 80%;
            max-width: 500px;
        }

        input, select {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        button {
            background: #ffcc00;
            color: #1a2a6c;
            border: none;
            padding: 15px 30px;
            margin: 20px 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #ffdd44;
            transform: scale(1.05);
        }

        .character-selection {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .character-card {
            width: 140px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .character-card:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-5px);
        }

        .character-card.selected {
            background: rgba(255, 204, 0, 0.3);
            border: 2px solid #ffcc00;
        }

        .character-image {
            width: 80px;
            height: 80px;
            background: #555;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .game-area {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }

        .player-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .elixir-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .elixir-bar {
            width: 200px;
            height: 25px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            overflow: hidden;
        }

        .elixir-fill {
            height: 100%;
            width: 50%;
            background: linear-gradient(to right, #8A2BE2, #4B0082);
            border-radius: 12px;
            transition: width 0.5s;
        }

        .elixir-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffcc00;
            min-width: 30px;
        }

        .battlefield {
            flex-grow: 1;
            background: linear-gradient(to bottom, #2a553e, #4a755e);
            position: relative;
            overflow: hidden;
        }

        .river {
            position: absolute;
            top: 45%;
            left: 0;
            width: 100%;
            height: 10%;
            background: linear-gradient(to right, #1a5f7a, #2a8bb8, #1a5f7a);
            z-index: 1;
        }

        .tower {
            position: absolute;
            width: 80px;
            height: 140px;
            background: #8B4513;
            border-radius: 10px;
            z-index: 2;
        }

        #player1-tower {
            bottom: 50px;
            left: 20%;
        }

        #player2-tower {
            top: 50px;
            right: 20%;
        }

        .tower-top {
            position: absolute;
            width: 100px;
            height: 50px;
            background: #A52A2A;
            border-radius: 10px;
            top: -25px;
            left: -10px;
        }

        .tower-health {
            position: absolute;
            bottom: -30px;
            left: 0;
            width: 100%;
            text-align: center;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        .cards-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }

        .game-card {
            width: 100px;
            height: 130px;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }

        .game-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 20px rgba(255, 204, 0, 0.5);
            border-color: #ffcc00;
        }

        .game-card:active {
            transform: translateY(0);
        }

        .card-cost {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #8A2BE2;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .card-image {
            width: 60px;
            height: 60px;
            background: #555;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            margin: 10px 0;
        }

        .card-name {
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 5px;
        }

        .unit {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.5s;
            cursor: pointer;
        }

        .player1-unit {
            background: #3498db;
        }

        .player2-unit {
            background: #e74c3c;
        }

        .health-bar {
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            width: 100%;
            background: #2ecc71;
            transition: width 0.3s;
        }

        .placement-area {
            position: absolute;
            width: 100%;
            height: 40%;
            z-index: 2;
            opacity: 0.3;
            pointer-events: none;
        }

        #player1-placement {
            bottom: 0;
            background: rgba(52, 152, 219, 0.3);
            border-top: 2px dashed #3498db;
        }

        #player2-placement {
            top: 0;
            background: rgba(231, 76, 60, 0.3);
            border-bottom: 2px dashed #e74c3c;
        }

        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            z-index: 100;
            text-align: center;
            border: 3px solid #ffcc00;
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .hidden {
            display: none;
        }

        .instructions {
            margin-top: 20px;
            color: #ccc;
            font-size: 1rem;
            max-width: 600px;
        }
    </style>
</head>
<body>
    <!-- Schermata iniziale -->
    <div id="start-screen" class="screen">
        <div>
            <h1>Clash Royale Style Game</h1>
            
            <div class="player-input">
                <h2>Giocatore 1</h2>
                <input type="text" id="player1-name" placeholder="Nome Giocatore 1">
                
                <h3>Seleziona Personaggio</h3>
                <div class="character-selection">
                    <div class="character-card" data-character="archer">
                        <div class="character-image">üèπ</div>
                        <p>Arciere</p>
                    </div>
                    <div class="character-card" data-character="knight">
                        <div class="character-image">‚öîÔ∏è</div>
                        <p>Cavaliere</p>
                    </div>
                    <div class="character-card" data-character="wizard">
                        <div class="character-image">üîÆ</div>
                        <p>Mago</p>
                    </div>
                    <div class="character-card" data-character="giant">
                        <div class="character-image">üõ°Ô∏è</div>
                        <p>Gigante</p>
                    </div>
                </div>
            </div>
            
            <div class="player-input">
                <h2>Giocatore 2</h2>
                <input type="text" id="player2-name" placeholder="Nome Giocatore 2">
                
                <h3>Seleziona Personaggio</h3>
                <div class="character-selection">
                    <div class="character-card" data-character="archer">
                        <div class="character-image">üèπ</div>
                        <p>Arciere</p>
                    </div>
                    <div class="character-card" data-character="knight">
                        <div class="character-image">‚öîÔ∏è</div>
                        <p>Cavaliere</p>
                    </div>
                    <div class="character-card" data-character="wizard">
                        <div class="character-image">üîÆ</div>
                        <p>Mago</p>
                    </div>
                    <div class="character-card" data-character="giant">
                        <div class="character-image">üõ°Ô∏è</div>
                        <p>Gigante</p>
                    </div>
                </div>
            </div>
            
            <button id="start-button">Inizia Partita</button>
            
            <div class="instructions">
                <p>Ogni giocatore pu√≤ posizionare le unit√† solo nella propria met√† campo (area colorata).</p>
                <p>Usa l'elisir per schierare unit√† che attaccheranno automaticamente la torre avversaria.</p>
            </div>
        </div>
    </div>
    
    <!-- Schermata di gioco -->
    <div id="game-screen" class="screen">
        <div class="game-area">
            <div class="player-info">
                <div class="player-details">
                    <h2 id="player1-display-name">Giocatore 1</h2>
                    <div class="elixir-container">
                        <div class="elixir-bar">
                            <div id="player1-elixir" class="elixir-fill"></div>
                        </div>
                        <div id="player1-elixir-count" class="elixir-count">5</div>
                    </div>
                </div>
                
                <div id="timer" class="timer">90</div>
                
                <div class="player-details">
                    <div class="elixir-container">
                        <div class="elixir-count" id="player2-elixir-count">5</div>
                        <div class="elixir-bar">
                            <div id="player2-elixir" class="elixir-fill"></div>
                        </div>
                    </div>
                    <h2 id="player2-display-name">Giocatore 2</h2>
                </div>
            </div>
            
            <div class="battlefield">
                <div class="placement-area" id="player1-placement"></div>
                <div class="placement-area" id="player2-placement"></div>
                
                <div class="river"></div>
                
                <div id="player1-tower" class="tower">
                    <div class="tower-top"></div>
                    <div class="health-bar">
                        <div id="player1-tower-health" class="health-fill"></div>
                    </div>
                    <div class="tower-health" id="player1-tower-health-text">100%</div>
                </div>
                
                <div id="player2-tower" class="tower">
                    <div class="tower-top"></div>
                    <div class="health-bar">
                        <div id="player2-tower-health" class="health-fill"></div>
                    </div>
                    <div class="tower-health" id="player2-tower-health-text">100%</div>
                </div>
                
                <!-- Le unit√† verranno aggiunte qui dinamicamente -->
            </div>
            
            <div class="cards-container" id="player1-cards">
                <!-- Le carte verranno aggiunte qui dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Schermata finale -->
    <div id="end-screen" class="screen">
        <h1>Partita Terminata</h1>
        <div id="winner-message" style="font-size: 2rem; margin: 20px 0;"></div>
        <button id="play-again-button">Rigioca</button>
    </div>

    <script>
        // Dati del gioco
        const gameData = {
            players: [
                { name: "", character: "", elixir: 5, towerHealth: 100 },
                { name: "", character: "", elixir: 5, towerHealth: 100 }
            ],
            characters: {
                archer: { name: "Arciere", cost: 3, damage: 15, health: 50, speed: 4, emoji: "üèπ" },
                knight: { name: "Cavaliere", cost: 4, damage: 25, health: 100, speed: 2, emoji: "‚öîÔ∏è" },
                wizard: { name: "Mago", cost: 5, damage: 35, health: 60, speed: 2, emoji: "üîÆ" },
                giant: { name: "Gigante", cost: 6, damage: 20, health: 200, speed: 1, emoji: "üõ°Ô∏è" }
            },
            gameState: "start", // start, playing, ended
            timer: 90,
            units: [],
            currentPlayer: 0,
            elixirGenerationRate: 0.3, // elisir per secondo (aumentato)
            lastElixirUpdate: Date.now(),
            battlefieldWidth: 0,
            battlefieldHeight: 0
        };

        // Elementi DOM
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startButton = document.getElementById('start-button');
        const playAgainButton = document.getElementById('play-again-button');
        const player1NameInput = document.getElementById('player1-name');
        const player2NameInput = document.getElementById('player2-name');
        const characterCards = document.querySelectorAll('.character-card');
        const player1DisplayName = document.getElementById('player1-display-name');
        const player2DisplayName = document.getElementById('player2-display-name');
        const player1Elixir = document.getElementById('player1-elixir');
        const player2Elixir = document.getElementById('player2-elixir');
        const player1ElixirCount = document.getElementById('player1-elixir-count');
        const player2ElixirCount = document.getElementById('player2-elixir-count');
        const player1TowerHealth = document.getElementById('player1-tower-health');
        const player2TowerHealth = document.getElementById('player2-tower-health');
        const player1TowerHealthText = document.getElementById('player1-tower-health-text');
        const player2TowerHealthText = document.getElementById('player2-tower-health-text');
        const timerElement = document.getElementById('timer');
        const winnerMessage = document.getElementById('winner-message');
        const battlefield = document.querySelector('.battlefield');
        const player1CardsContainer = document.getElementById('player1-cards');
        const player2CardsContainer = document.getElementById('player2-cards');

        // Variabili di gioco
        let gameInterval;
        let selectedCharacters = [null, null];
        let placingUnit = false;
        let currentPlacingUnit = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Aggiungi event listeners
            startButton.addEventListener('click', startGame);
            playAgainButton.addEventListener('click', resetGame);
            
            // Aggiungi event listeners per selezione personaggi
            characterCards.forEach(card => {
                card.addEventListener('click', function() {
                    const character = this.getAttribute('data-character');
                    const playerIndex = this.closest('.player-input') ? 
                        (this.closest('.player-input').querySelector('h2').textContent === 'Giocatore 1' ? 0 : 1) : 0;
                    
                    // Deseleziona altre carte dello stesso giocatore
                    const playerCards = this.closest('.player-input').querySelectorAll('.character-card');
                    playerCards.forEach(c => c.classList.remove('selected'));
                    
                    // Seleziona questa carta
                    this.classList.add('selected');
                    selectedCharacters[playerIndex] = character;
                });
            });
            
            // Imposta dimensioni campo di battaglia
            updateBattlefieldSize();
            window.addEventListener('resize', updateBattlefieldSize);
        }

        function updateBattlefieldSize() {
            gameData.battlefieldWidth = battlefield.offsetWidth;
            gameData.battlefieldHeight = battlefield.offsetHeight;
        }

        function startGame() {
            // Verifica che i nomi e i personaggi siano stati selezionati
            if (!player1NameInput.value || !player2NameInput.value) {
                alert("Inserisci i nomi di entrambi i giocatori!");
                return;
            }
            
            if (!selectedCharacters[0] || !selectedCharacters[1]) {
                alert("Seleziona un personaggio per entrambi i giocatori!");
                return;
            }
            
            // Imposta i dati dei giocatori
            gameData.players[0].name = player1NameInput.value;
            gameData.players[0].character = selectedCharacters[0];
            gameData.players[0].elixir = 5;
            gameData.players[0].towerHealth = 100;
            
            gameData.players[1].name = player2NameInput.value;
            gameData.players[1].character = selectedCharacters[1];
            gameData.players[1].elixir = 5;
            gameData.players[1].towerHealth = 100;
            
            // Aggiorna la UI
            player1DisplayName.textContent = gameData.players[0].name;
            player2DisplayName.textContent = gameData.players[1].name;
            updateElixirBars();
            updateTowerHealth();
            
            // Crea le carte per i giocatori
            createPlayerCards();
            
            // Cambia schermata
            startScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            
            // Avvia il gioco
            gameData.gameState = "playing";
            gameData.timer = 90;
            gameData.units = [];
            gameData.currentPlayer = 0;
            gameData.lastElixirUpdate = Date.now();
            
            // Avvia il loop di gioco
            gameInterval = setInterval(gameLoop, 100);
        }

        function gameLoop() {
            // Aggiorna l'elisir
            updateElixir();
            
            // Aggiorna le unit√†
            updateUnits();
            
            // Aggiorna il timer
            updateTimer();
            
            // Controlla condizioni di vittoria
            checkWinConditions();
        }

        function updateElixir() {
            const now = Date.now();
            const elapsed = (now - gameData.lastElixirUpdate) / 1000; // secondi
            
            if (elapsed >= 1) {
                gameData.players[0].elixir = Math.min(gameData.players[0].elixir + gameData.elixirGenerationRate, 10);
                gameData.players[1].elixir = Math.min(gameData.players[1].elixir + gameData.elixirGenerationRate, 10);
                gameData.lastElixirUpdate = now;
                updateElixirBars();
            }
        }

        function updateElixirBars() {
            player1Elixir.style.width = (gameData.players[0].elixir * 10) + '%';
            player2Elixir.style.width = (gameData.players[1].elixir * 10) + '%';
            player1ElixirCount.textContent = Math.floor(gameData.players[0].elixir);
            player2ElixirCount.textContent = Math.floor(gameData.players[1].elixir);
        }

        function updateTowerHealth() {
            player1TowerHealth.style.width = gameData.players[0].towerHealth + '%';
            player2TowerHealth.style.width = gameData.players[1].towerHealth + '%';
            player1TowerHealthText.textContent = Math.max(0, Math.floor(gameData.players[0].towerHealth)) + '%';
            player2TowerHealthText.textContent = Math.max(0, Math.floor(gameData.players[1].towerHealth)) + '%';
        }

        function updateTimer() {
            gameData.timer -= 0.1;
            timerElement.textContent = Math.max(0, Math.ceil(gameData.timer));
            
            if (gameData.timer <= 0) {
                endGame("time");
            }
        }

        function createPlayerCards() {
            // Pulisci i contenitori delle carte
            player1CardsContainer.innerHTML = '';
            
            // Crea 4 carte per ogni giocatore
            for (let i = 0; i < 4; i++) {
                const characterKeys = Object.keys(gameData.characters);
                const randomCharacterKey = characterKeys[Math.floor(Math.random() * characterKeys.length)];
                const character = gameData.characters[randomCharacterKey];
                
                // Crea carta per giocatore 1
                const card1 = createCardElement(character, randomCharacterKey, 0);
                player1CardsContainer.appendChild(card1);
            }
        }

        function createCardElement(character, characterKey, playerIndex) {
            const card = document.createElement('div');
            card.className = 'game-card';
            card.setAttribute('data-character', characterKey);
            card.setAttribute('data-player', playerIndex);
            
            const cost = document.createElement('div');
            cost.className = 'card-cost';
            cost.textContent = character.cost;
            
            const image = document.createElement('div');
            image.className = 'card-image';
            image.textContent = character.emoji;
            
            const name = document.createElement('div');
            name.className = 'card-name';
            name.textContent = character.name;
            
            card.appendChild(cost);
            card.appendChild(image);
            card.appendChild(name);
            
            // Aggiungi event listener per il click sulla carta
            card.addEventListener('click', function() {
                if (!placingUnit) {
                    startPlacingUnit(this, playerIndex);
                }
            });
            
            return card;
        }

        function startPlacingUnit(cardElement, playerIndex) {
            const characterKey = cardElement.getAttribute('data-character');
            const character = gameData.characters[characterKey];
            
            // Verifica se il giocatore ha abbastanza elisir
            if (gameData.players[playerIndex].elixir < character.cost) {
                alert("Elisir insufficiente!");
                return;
            }
            
            // Inizia il posizionamento
            placingUnit = true;
            currentPlacingUnit = {
                player: playerIndex,
                type: characterKey,
                character: character
            };
            
            // Aggiungi event listener per il click sul campo di battaglia
            battlefield.addEventListener('click', placeUnitOnBattlefield);
            battlefield.style.cursor = 'crosshair';
        }

        function placeUnitOnBattlefield(event) {
            if (!placingUnit || !currentPlacingUnit) return;
            
            const rect = battlefield.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // Verifica che il posizionamento sia nella met√† campo corretta
            const playerIndex = currentPlacingUnit.player;
            const placementArea = playerIndex === 0 ? 
                { top: gameData.battlefieldHeight * 0.6, bottom: gameData.battlefieldHeight } :
                { top: 0, bottom: gameData.battlefieldHeight * 0.4 };
            
            if (y < placementArea.top || y > placementArea.bottom) {
                alert("Puoi posizionare unit√† solo nella tua met√† campo!");
                return;
            }
            
            // Sottrai l'elisir
            gameData.players[playerIndex].elixir -= currentPlacingUnit.character.cost;
            updateElixirBars();
            
            // Crea l'unit√†
            const unit = {
                player: playerIndex,
                type: currentPlacingUnit.type,
                health: currentPlacingUnit.character.health,
                maxHealth: currentPlacingUnit.character.health,
                damage: currentPlacingUnit.character.damage,
                speed: currentPlacingUnit.character.speed,
                x: x,
                y: y,
                element: null
            };
            
            gameData.units.push(unit);
            
            // Aggiungi l'unit√† al campo di battaglia
            addUnitToBattlefield(unit);
            
            // Rimuovi la carta e sostituiscila con una nuova
            const cardElement = document.querySelector('.game-card[data-character="' + currentPlacingUnit.type + '"]');
            const newCharacterKeys = Object.keys(gameData.characters);
            const newRandomCharacterKey = newCharacterKeys[Math.floor(Math.random() * newCharacterKeys.length)];
            const newCharacter = gameData.characters[newRandomCharacterKey];
            
            const newCard = createCardElement(newCharacter, newRandomCharacterKey, playerIndex);
            cardElement.parentNode.replaceChild(newCard, cardElement);
            
            // Termina il posizionamento
            endPlacingUnit();
        }

        function endPlacingUnit() {
            placingUnit = false;
            currentPlacingUnit = null;
            battlefield.removeEventListener('click', placeUnitOnBattlefield);
            battlefield.style.cursor = 'default';
        }

        function addUnitToBattlefield(unit) {
            const unitElement = document.createElement('div');
            unitElement.className = `unit player${unit.player+1}-unit`;
            unitElement.style.left = (unit.x - 25) + 'px';
            unitElement.style.top = (unit.y - 25) + 'px';
            unitElement.innerHTML = `
                ${gameData.characters[unit.type].emoji}
                <div class="health-bar">
                    <div class="health-fill" style="width: 100%"></div>
                </div>
            `;
            
            battlefield.appendChild(unitElement);
            unit.element = unitElement;
        }

        function updateUnits() {
            gameData.units.forEach(unit => {
                // Muovi l'unit√† verso la torre avversaria
                const targetX = unit.player === 0 ? gameData.battlefieldWidth : 0;
                const direction = unit.player === 0 ? 1 : -1;
                
                unit.x += unit.speed * direction;
                
                // Aggiorna la posizione
                unit.element.style.left = (unit.x - 25) + 'px';
                
                // Controlla collisioni con le torri
                checkTowerCollision(unit);
                
                // Controlla collisioni con altre unit√†
                checkUnitCollisions(unit);
                
                // Aggiorna la barra della salute
                const healthFill = unit.element.querySelector('.health-fill');
                healthFill.style.width = (unit.health / unit.maxHealth) * 100 + '%';
                
                // Rimuovi le unit√† morte
                if (unit.health <= 0) {
                    unit.element.remove();
                    gameData.units = gameData.units.filter(u => u !== unit);
                }
            });
        }

        function checkTowerCollision(unit) {
            const tower = unit.player === 0 ? gameData.players[1] : gameData.players[0];
            const towerX = unit.player === 0 ? gameData.battlefieldWidth - 100 : 100;
            const towerY = gameData.battlefieldHeight / 2;
            
            // Se l'unit√† √® vicina alla torre avversaria
            const distance = Math.sqrt(Math.pow(unit.x - towerX, 2) + Math.pow(unit.y - towerY, 2));
            if (distance < 80) {
                // Infliggi danni alla torre
                tower.towerHealth -= unit.damage / 20;
                updateTowerHealth();
                
                // L'unit√† muore dopo l'attacco (per semplicit√†)
                unit.health = 0;
            }
        }

        function checkUnitCollisions(unit) {
            gameData.units.forEach(otherUnit => {
                // Se l'unit√† √® avversaria e vicina
                if (otherUnit.player !== unit.player) {
                    const distance = Math.sqrt(Math.pow(unit.x - otherUnit.x, 2) + Math.pow(unit.y - otherUnit.y, 2));
                    
                    if (distance < 60) {
                        // Le unit√† si attaccano a vicenda
                        unit.health -= otherUnit.damage;
                        otherUnit.health -= unit.damage;
                    }
                }
            });
        }

        function checkWinConditions() {
            // Controlla se una torre √® stata distrutta
            if (gameData.players[0].towerHealth <= 0) {
                endGame("player2");
                return;
            }
            
            if (gameData.players[1].towerHealth <= 0) {
                endGame("player1");
                return;
            }
        }

        function endGame(reason) {
            clearInterval(gameInterval);
            gameData.gameState = "ended";
            endPlacingUnit();
            
            // Determina il vincitore
            let winner;
            if (reason === "player1") {
                winner = gameData.players[0].name;
            } else if (reason === "player2") {
                winner = gameData.players[1].name;
            } else {
                // In caso di timeout, vince chi ha pi√π salute della torre
                winner = gameData.players[0].towerHealth > gameData.players[1].towerHealth ? 
                    gameData.players[0].name : gameData.players[1].name;
            }
            
            // Mostra il messaggio del vincitore
            winnerMessage.textContent = `${winner} ha vinto la partita!`;
            
            // Cambia schermata
            gameScreen.style.display = 'none';
            endScreen.style.display = 'flex';
        }

        function resetGame() {
            // Ripristina lo stato del gioco
            gameData.players[0].towerHealth = 100;
            gameData.players[1].towerHealth = 100;
            gameData.units = [];
            
            // Rimuovi tutte le unit√† dal campo di battaglia
            const units = document.querySelectorAll('.unit');
            units.forEach(unit => unit.remove());
            
            // Torna alla schermata iniziale
            endScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            
            // Deseleziona i personaggi
            characterCards.forEach(card => card.classList.remove('selected'));
            selectedCharacters = [null, null];
            
            // Resetta i campi di input
            player1NameInput.value = '';
            player2NameInput.value = '';
        }
    </script>
</body>
</html>