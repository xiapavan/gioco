<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash Royale Style - Ghiaccio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #2a3a7c);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow: hidden;
        }

        .screen {
            width: 100%;
            max-width: 1000px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            display: none;
        }

        #start-screen {
            display: block;
        }

        h1 {
            color: #4fc3f7;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .player-input {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        input {
            width: 80%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
        }

        button {
            background: #4fc3f7;
            color: #1a2a6c;
            border: none;
            padding: 12px 25px;
            margin: 15px 5px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #81d4fa;
            transform: scale(1.05);
        }

        .game-area {
            display: flex;
            flex-direction: column;
            height: 80vh;
            min-height: 600px;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .battlefield {
            flex-grow: 1;
            background: linear-gradient(to bottom, #bbdefb, #e3f2fd);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            margin: 10px 0;
            border: 3px solid #64b5f6;
        }

        .ice-path {
            position: absolute;
            width: 80%;
            height: 60%;
            top: 20%;
            left: 10%;
            background: linear-gradient(to bottom, #e1f5fe, #b3e5fc);
            border-radius: 10px;
            z-index: 1;
        }

        .king-tower-path {
            position: absolute;
            width: 20%;
            height: 60%;
            top: 20%;
            left: 40%;
            background: linear-gradient(to bottom, #e1f5fe, #b3e5fc);
            border-radius: 10px;
            z-index: 1;
        }

        .tower {
            position: absolute;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tower-base {
            width: 60px;
            height: 60px;
            background: #5d4037;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #3e2723;
        }

        .tower-top {
            width: 40px;
            height: 40px;
            background: #8d6e63;
            border-radius: 50%;
            margin-top: -10px;
            border: 3px solid #5d4037;
        }

        .king-tower .tower-base {
            width: 80px;
            height: 80px;
            background: #ff9800;
        }

        .king-tower .tower-top {
            width: 60px;
            height: 60px;
            background: #ffb74d;
        }

        .health-bar {
            width: 100%;
            height: 5px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .health-fill {
            height: 100%;
            width: 100%;
            background: #4caf50;
            transition: width 0.3s;
        }

        #player1-king-tower {
            bottom: 10px;
            left: 45%;
        }

        #player1-left-tower {
            bottom: 10px;
            left: 20%;
        }

        #player1-right-tower {
            bottom: 10px;
            right: 20%;
        }

        #player2-king-tower {
            top: 10px;
            left: 45%;
        }

        #player2-left-tower {
            top: 10px;
            left: 20%;
        }

        #player2-right-tower {
            top: 10px;
            right: 20%;
        }

        .elixir-bar {
            height: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }

        .elixir-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #7b1fa2, #9c27b0);
            border-radius: 10px;
            transition: width 0.5s;
        }

        .cards-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .game-card {
            width: 80px;
            height: 100px;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        .game-card.draggable {
            cursor: grab;
        }

        .game-card.dragging {
            opacity: 0.8;
            transform: scale(1.1);
            z-index: 10;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(79, 195, 247, 0.5);
        }

        .card-cost {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #7b1fa2;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .card-image {
            width: 50px;
            height: 50px;
            background: #555;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 5px 0;
        }

        .unit {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.5s;
            user-select: none;
            pointer-events: none;
        }

        .player1-unit {
            background: #3498db;
            bottom: 10px;
        }

        .player2-unit {
            background: #e74c3c;
            top: 10px;
        }

        .unit-health-bar {
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 5px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 2px;
            overflow: hidden;
        }

        .unit-health-fill {
            height: 100%;
            width: 100%;
            background: #2ecc71;
            transition: width 0.3s;
        }

        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 10;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .drop-zone {
            position: absolute;
            width: 100%;
            height: 45%;
            z-index: 2;
        }

        #player1-drop-zone {
            bottom: 0;
        }

        #player2-drop-zone {
            top: 0;
        }
    </style>
</head>
<body>
    <!-- Schermata iniziale -->
    <div id="start-screen" class="screen">
        <h1>Clash Royale Style - Regno di Ghiaccio</h1>
        
        <div class="player-input">
            <h2>Giocatore 1</h2>
            <input type="text" id="player1-name" placeholder="Nome Giocatore 1">
        </div>
        
        <div class="player-input">
            <h2>Giocatore 2</h2>
            <input type="text" id="player2-name" placeholder="Nome Giocatore 2">
        </div>
        
        <button id="start-button">Inizia Partita</button>
    </div>
    
    <!-- Schermata di gioco -->
    <div id="game-screen" class="screen">
        <div class="game-area">
            <div class="player-info">
                <div id="player1-info">
                    <h2 id="player1-display-name">Giocatore 1</h2>
                    <div class="elixir-bar">
                        <div id="player1-elixir" class="elixir-fill"></div>
                    </div>
                </div>
                <div id="timer">180</div>
                <div id="player2-info">
                    <h2 id="player2-display-name">Giocatore 2</h2>
                    <div class="elixir-bar">
                        <div id="player2-elixir" class="elixir-fill"></div>
                    </div>
                </div>
            </div>
            
            <div class="battlefield">
                <div class="ice-path"></div>
                <div class="king-tower-path"></div>
                
                <!-- Torri Giocatore 1 -->
                <div id="player1-king-tower" class="tower king-tower">
                    <div class="tower-base">
                        <div class="tower-top"></div>
                    </div>
                    <div class="health-bar">
                        <div id="player1-king-tower-health" class="health-fill"></div>
                    </div>
                </div>
                
                <div id="player1-left-tower" class="tower">
                    <div class="tower-base">
                        <div class="tower-top"></div>
                    </div>
                    <div class="health-bar">
                        <div id="player1-left-tower-health" class="health-fill"></div>
                    </div>
                </div>
                
                <div id="player1-right-tower" class="tower">
                    <div class="tower-base">
                        <div class="tower-top"></div>
                    </div>
                    <div class="health-bar">
                        <div id="player1-right-tower-health" class="health-fill"></div>
                    </div>
                </div>
                
                <!-- Torri Giocatore 2 -->
                <div id="player2-king-tower" class="tower king-tower">
                    <div class="tower-base">
                        <div class="tower-top"></div>
                    </div>
                    <div class="health-bar">
                        <div id="player2-king-tower-health" class="health-fill"></div>
                    </div>
                </div>
                
                <div id="player2-left-tower" class="tower">
                    <div class="tower-base">
                        <div class="tower-top"></div>
                    </div>
                    <div class="health-bar">
                        <div id="player2-left-tower-health" class="health-fill"></div>
                    </div>
                </div>
                
                <div id="player2-right-tower" class="tower">
                    <div class="tower-base">
                        <div class="tower-top"></div>
                    </div>
                    <div class="health-bar">
                        <div id="player2-right-tower-health" class="health-fill"></div>
                    </div>
                </div>
                
                <!-- Zone di rilascio -->
                <div id="player1-drop-zone" class="drop-zone"></div>
                <div id="player2-drop-zone" class="drop-zone"></div>
                
                <!-- Le unit√† verranno aggiunte qui dinamicamente -->
            </div>
            
            <div class="cards-container" id="player1-cards">
                <!-- Le carte verranno aggiunte qui dinamicamente -->
            </div>
            
            <div class="cards-container" id="player2-cards">
                <!-- Le carte verranno aggiunte qui dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- Schermata finale -->
    <div id="end-screen" class="screen">
        <h1>Partita Terminata</h1>
        <div id="winner-message"></div>
        <button id="play-again-button">Rigioca</button>
    </div>

    <script>
        // Dati del gioco
        const gameData = {
            players: [
                { 
                    name: "", 
                    elixir: 5, 
                    towers: {
                        king: { health: 100, maxHealth: 100 },
                        left: { health: 50, maxHealth: 50 },
                        right: { health: 50, maxHealth: 50 }
                    }
                },
                { 
                    name: "", 
                    elixir: 5, 
                    towers: {
                        king: { health: 100, maxHealth: 100 },
                        left: { health: 50, maxHealth: 50 },
                        right: { health: 50, maxHealth: 50 }
                    }
                }
            ],
            characters: {
                archer: { name: "Arciere", cost: 3, damage: 15, health: 50, speed: 2, emoji: "üèπ" },
                knight: { name: "Cavaliere", cost: 4, damage: 25, health: 100, speed: 1.5, emoji: "‚öîÔ∏è" },
                wizard: { name: "Mago", cost: 5, damage: 35, health: 60, speed: 1, emoji: "üîÆ" },
                giant: { name: "Gigante", cost: 6, damage: 20, health: 200, speed: 0.8, emoji: "üõ°Ô∏è" },
                goblin: { name: "Goblin", cost: 2, damage: 10, health: 30, speed: 3, emoji: "üë∫" },
                icewizard: { name: "Mago di Ghiaccio", cost: 4, damage: 20, health: 70, speed: 1, emoji: "‚ùÑÔ∏è" },
                valkyrie: { name: "Valkiria", cost: 5, damage: 30, health: 120, speed: 1.2, emoji: "‚öîÔ∏è" },
                dragon: { name: "Drago", cost: 7, damage: 40, health: 150, speed: 1.5, emoji: "üê≤" }
            },
            gameState: "start", // start, playing, ended
            timer: 180,
            units: [],
            currentPlayer: 0,
            elixirGenerationRate: 0.2, // elisir per secondo
            lastElixirUpdate: Date.now()
        };

        // Elementi DOM
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startButton = document.getElementById('start-button');
        const playAgainButton = document.getElementById('play-again-button');
        const player1NameInput = document.getElementById('player1-name');
        const player2NameInput = document.getElementById('player2-name');
        const player1DisplayName = document.getElementById('player1-display-name');
        const player2DisplayName = document.getElementById('player2-display-name');
        const player1Elixir = document.getElementById('player1-elixir');
        const player2Elixir = document.getElementById('player2-elixir');
        const timerElement = document.getElementById('timer');
        const winnerMessage = document.getElementById('winner-message');
        const battlefield = document.querySelector('.battlefield');
        const player1CardsContainer = document.getElementById('player1-cards');
        const player2CardsContainer = document.getElementById('player2-cards');
        const player1DropZone = document.getElementById('player1-drop-zone');
        const player2DropZone = document.getElementById('player2-drop-zone');

        // Riferimenti alle torri
        const towerHealthElements = {
            player1: {
                king: document.getElementById('player1-king-tower-health'),
                left: document.getElementById('player1-left-tower-health'),
                right: document.getElementById('player1-right-tower-health')
            },
            player2: {
                king: document.getElementById('player2-king-tower-health'),
                left: document.getElementById('player2-left-tower-health'),
                right: document.getElementById('player2-right-tower-health')
            }
        };

        // Variabili di gioco
        let gameInterval;
        let draggedCard = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Aggiungi event listeners
            startButton.addEventListener('click', startGame);
            playAgainButton.addEventListener('click', resetGame);
            
            // Aggiungi event listeners per il drag and drop
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
            
            document.addEventListener('mousedown', handleMouseDown);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function startGame() {
            // Verifica che i nomi siano stati inseriti
            if (!player1NameInput.value || !player2NameInput.value) {
                alert("Inserisci i nomi di entrambi i giocatori!");
                return;
            }
            
            // Imposta i dati dei giocatori
            gameData.players[0].name = player1NameInput.value;
            gameData.players[0].elixir = 5;
            resetTowers(0);
            
            gameData.players[1].name = player2NameInput.value;
            gameData.players[1].elixir = 5;
            resetTowers(1);
            
            // Aggiorna la UI
            player1DisplayName.textContent = gameData.players[0].name;
            player2DisplayName.textContent = gameData.players[1].name;
            updateElixirBars();
            updateTowerHealth();
            
            // Crea le carte per i giocatori
            createPlayerCards();
            
            // Cambia schermata
            startScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            
            // Avvia il gioco
            gameData.gameState = "playing";
            gameData.timer = 180;
            gameData.units = [];
            gameData.currentPlayer = 0;
            gameData.lastElixirUpdate = Date.now();
            
            // Avvia il loop di gioco
            gameInterval = setInterval(gameLoop, 100);
        }

        function resetTowers(playerIndex) {
            const player = gameData.players[playerIndex];
            player.towers.king.health = player.towers.king.maxHealth;
            player.towers.left.health = player.towers.left.maxHealth;
            player.towers.right.health = player.towers.right.maxHealth;
        }

        function gameLoop() {
            // Aggiorna l'elisir
            updateElixir();
            
            // Aggiorna le unit√†
            updateUnits();
            
            // Aggiorna il timer
            updateTimer();
            
            // Controlla condizioni di vittoria
            checkWinConditions();
        }

        function updateElixir() {
            const now = Date.now();
            const elapsed = (now - gameData.lastElixirUpdate) / 1000; // secondi
            
            if (elapsed >= 1) {
                gameData.players[0].elixir = Math.min(gameData.players[0].elixir + gameData.elixirGenerationRate, 10);
                gameData.players[1].elixir = Math.min(gameData.players[1].elixir + gameData.elixirGenerationRate, 10);
                gameData.lastElixirUpdate = now;
                updateElixirBars();
            }
        }

        function updateElixirBars() {
            player1Elixir.style.width = (gameData.players[0].elixir * 10) + '%';
            player2Elixir.style.width = (gameData.players[1].elixir * 10) + '%';
        }

        function updateTowerHealth() {
            // Giocatore 1
            towerHealthElements.player1.king.style.width = 
                (gameData.players[0].towers.king.health / gameData.players[0].towers.king.maxHealth * 100) + '%';
            towerHealthElements.player1.left.style.width = 
                (gameData.players[0].towers.left.health / gameData.players[0].towers.left.maxHealth * 100) + '%';
            towerHealthElements.player1.right.style.width = 
                (gameData.players[0].towers.right.health / gameData.players[0].towers.right.maxHealth * 100) + '%';
            
            // Giocatore 2
            towerHealthElements.player2.king.style.width = 
                (gameData.players[1].towers.king.health / gameData.players[1].towers.king.maxHealth * 100) + '%';
            towerHealthElements.player2.left.style.width = 
                (gameData.players[1].towers.left.health / gameData.players[1].towers.left.maxHealth * 100) + '%';
            towerHealthElements.player2.right.style.width = 
                (gameData.players[1].towers.right.health / gameData.players[1].towers.right.maxHealth * 100) + '%';
        }

        function updateTimer() {
            gameData.timer -= 0.1;
            timerElement.textContent = Math.max(0, Math.ceil(gameData.timer));
            
            if (gameData.timer <= 0) {
                endGame("time");
            }
        }

        function createPlayerCards() {
            // Pulisci i contenitori delle carte
            player1CardsContainer.innerHTML = '';
            player2CardsContainer.innerHTML = '';
            
            // Crea 4 carte per ogni giocatore
            for (let i = 0; i < 4; i++) {
                const characterKeys = Object.keys(gameData.characters);
                const randomCharacterKey = characterKeys[Math.floor(Math.random() * characterKeys.length)];
                const character = gameData.characters[randomCharacterKey];
                
                // Crea carta per giocatore 1
                const card1 = createCardElement(character, randomCharacterKey, 0);
                player1CardsContainer.appendChild(card1);
                
                // Crea carta per giocatore 2
                const card2 = createCardElement(character, randomCharacterKey, 1);
                player2CardsContainer.appendChild(card2);
            }
        }

        function createCardElement(character, characterKey, playerIndex) {
            const card = document.createElement('div');
            card.className = 'game-card draggable';
            card.setAttribute('data-character', characterKey);
            card.setAttribute('data-player', playerIndex);
            card.setAttribute('data-cost', character.cost);
            
            const cost = document.createElement('div');
            cost.className = 'card-cost';
            cost.textContent = character.cost;
            
            const image = document.createElement('div');
            image.className = 'card-image';
            image.textContent = character.emoji;
            
            const name = document.createElement('div');
            name.textContent = character.name;
            name.style.fontSize = '12px';
            name.style.marginTop = '5px';
            
            card.appendChild(cost);
            card.appendChild(image);
            card.appendChild(name);
            
            return card;
        }

        // Gestione del drag and drop per touch
        function handleTouchStart(e) {
            if (gameData.gameState !== "playing") return;
            
            const touch = e.touches[0];
            const card = touch.target.closest('.draggable');
            
            if (card) {
                e.preventDefault();
                startDrag(card, touch.clientX, touch.clientY);
            }
        }

        function handleTouchMove(e) {
            if (!draggedCard) return;
            
            const touch = e.touches[0];
            e.preventDefault();
            updateDrag(touch.clientX, touch.clientY);
        }

        function handleTouchEnd(e) {
            if (!draggedCard) return;
            
            endDrag();
        }

        // Gestione del drag and drop per mouse
        function handleMouseDown(e) {
            if (gameData.gameState !== "playing") return;
            
            const card = e.target.closest('.draggable');
            
            if (card) {
                startDrag(card, e.clientX, e.clientY);
            }
        }

        function handleMouseMove(e) {
            if (!draggedCard) return;
            
            updateDrag(e.clientX, e.clientY);
        }

        function handleMouseUp(e) {
            if (!draggedCard) return;
            
            endDrag();
        }

        function startDrag(card, clientX, clientY) {
            const playerIndex = parseInt(card.getAttribute('data-player'));
            const characterKey = card.getAttribute('data-character');
            const cost = parseInt(card.getAttribute('data-cost'));
            
            // Verifica se il giocatore ha abbastanza elisir
            if (gameData.players[playerIndex].elixir < cost) {
                alert("Elisir insufficiente!");
                return;
            }
            
            draggedCard = card;
            draggedCard.classList.add('dragging');
            
            // Calcola l'offset per mantenere la posizione del mouse relativa alla carta
            const rect = card.getBoundingClientRect();
            dragOffsetX = clientX - rect.left;
            dragOffsetY = clientY - rect.top;
            
            // Posiziona la carta sotto il cursore
            updateDrag(clientX, clientY);
        }

        function updateDrag(clientX, clientY) {
            if (!draggedCard) return;
            
            draggedCard.style.position = 'fixed';
            draggedCard.style.left = (clientX - dragOffsetX) + 'px';
            draggedCard.style.top = (clientY - dragOffsetY) + 'px';
        }

        function endDrag() {
            if (!draggedCard) return;
            
            const playerIndex = parseInt(draggedCard.getAttribute('data-player'));
            const characterKey = draggedCard.getAttribute('data-character');
            const cost = parseInt(draggedCard.getAttribute('data-cost'));
            
            // Ottieni la posizione della carta
            const rect = draggedCard.getBoundingClientRect();
            const battlefieldRect = battlefield.getBoundingClientRect();
            
            // Verifica se la carta √® stata rilasciata nella zona di gioco corretta
            const dropZone = playerIndex === 0 ? player1DropZone : player2DropZone;
            const dropZoneRect = dropZone.getBoundingClientRect();
            
            if (rect.top < dropZoneRect.bottom && rect.bottom > dropZoneRect.top &&
                rect.left < dropZoneRect.right && rect.right > dropZoneRect.left) {
                
                // Calcola la posizione relativa al campo di battaglia
                const x = rect.left - battlefieldRect.left + rect.width / 2;
                const y = rect.top - battlefieldRect.top + rect.height / 2;
                
                // Verifica se il giocatore ha abbastanza elisir
                if (gameData.players[playerIndex].elixir >= cost) {
                    // Sottrai l'elisir
                    gameData.players[playerIndex].elixir -= cost;
                    updateElixirBars();
                    
                    // Crea l'unit√†
                    createUnit(characterKey, playerIndex, x, y);
                    
                    // Sostituisci la carta con una nuova
                    replaceCard(draggedCard, playerIndex);
                }
            }
            
            // Ripristina la carta
            draggedCard.classList.remove('dragging');
            draggedCard.style.position = '';
            draggedCard.style.left = '';
            draggedCard.style.top = '';
            draggedCard = null;
        }

        function createUnit(characterKey, playerIndex, x, y) {
            const character = gameData.characters[characterKey];
            
            const unit = {
                player: playerIndex,
                type: characterKey,
                health: character.health,
                maxHealth: character.health,
                damage: character.damage,
                speed: character.speed,
                x: x,
                y: y,
                target: null,
                element: null
            };
            
            gameData.units.push(unit);
            
            // Aggiungi l'unit√† al campo di battaglia
            addUnitToBattlefield(unit);
        }

        function addUnitToBattlefield(unit) {
            const unitElement = document.createElement('div');
            unitElement.className = `unit player${unit.player+1}-unit`;
            unitElement.style.left = unit.x + 'px';
            unitElement.style.top = unit.y + 'px';
            unitElement.innerHTML = `
                ${gameData.characters[unit.type].emoji}
                <div class="unit-health-bar">
                    <div class="unit-health-fill" style="width: 100%"></div>
                </div>
            `;
            
            battlefield.appendChild(unitElement);
            unit.element = unitElement;
        }

        function replaceCard(cardElement, playerIndex) {
            const characterKeys = Object.keys(gameData.characters);
            const newRandomCharacterKey = characterKeys[Math.floor(Math.random() * characterKeys.length)];
            const newCharacter = gameData.characters[newRandomCharacterKey];
            
            const newCard = createCardElement(newCharacter, newRandomCharacterKey, playerIndex);
            cardElement.parentNode.replaceChild(newCard, cardElement);
        }

        function updateUnits() {
            gameData.units.forEach(unit => {
                // Trova un bersaglio se non ne ha uno
                if (!unit.target) {
                    unit.target = findTarget(unit);
                }
                
                // Muovi l'unit√† verso il bersaglio
                if (unit.target) {
                    moveUnitTowardsTarget(unit);
                    
                    // Controlla se √® abbastanza vicino per attaccare
                    if (isUnitInRange(unit, unit.target)) {
                        attackTarget(unit, unit.target);
                    }
                }
                
                // Aggiorna la barra della salute
                const healthFill = unit.element.querySelector('.unit-health-fill');
                healthFill.style.width = (unit.health / unit.maxHealth) * 100 + '%';
                
                // Rimuovi le unit√† morte
                if (unit.health <= 0) {
                    unit.element.remove();
                    gameData.units = gameData.units.filter(u => u !== unit);
                }
            });
        }

        function findTarget(unit) {
            // Cerca prima le unit√† nemiche
            for (const otherUnit of gameData.units) {
                if (otherUnit.player !== unit.player) {
                    return { type: 'unit', object: otherUnit };
                }
            }
            
            // Se non ci sono unit√† nemiche, cerca le torri
            const enemyPlayerIndex = unit.player === 0 ? 1 : 0;
            const enemyTowers = gameData.players[enemyPlayerIndex].towers;
            
            // Priorit√†: torri normali prima della torre del re
            if (enemyTowers.left.health > 0) {
                return { type: 'tower', object: enemyTowers.left, id: 'left' };
            } else if (enemyTowers.right.health > 0) {
                return { type: 'tower', object: enemyTowers.right, id: 'right' };
            } else if (enemyTowers.king.health > 0) {
                return { type: 'tower', object: enemyTowers.king, id: 'king' };
            }
            
            return null;
        }

        function moveUnitTowardsTarget(unit) {
            if (!unit.target) return;
            
            let targetX, targetY;
            
            if (unit.target.type === 'unit') {
                targetX = unit.target.object.x;
                targetY = unit.target.object.y;
            } else { // tower
                // Posiziona l'unit√† verso la torre appropriata
                const enemyPlayerIndex = unit.player === 0 ? 1 : 0;
                const towerId = unit.target.id;
                
                // Calcola la posizione approssimativa della torre
                if (enemyPlayerIndex === 0) { // Giocatore 1 (in basso)
                    if (towerId === 'king') {
                        targetX = battlefield.offsetWidth * 0.45;
                        targetY = battlefield.offsetHeight * 0.8;
                    } else if (towerId === 'left') {
                        targetX = battlefield.offsetWidth * 0.2;
                        targetY = battlefield.offsetHeight * 0.8;
                    } else { // right
                        targetX = battlefield.offsetWidth * 0.7;
                        targetY = battlefield.offsetHeight * 0.8;
                    }
                } else { // Giocatore 2 (in alto)
                    if (towerId === 'king') {
                        targetX = battlefield.offsetWidth * 0.45;
                        targetY = battlefield.offsetHeight * 0.2;
                    } else if (towerId === 'left') {
                        targetX = battlefield.offsetWidth * 0.2;
                        targetY = battlefield.offsetHeight * 0.2;
                    } else { // right
                        targetX = battlefield.offsetWidth * 0.7;
                        targetY = battlefield.offsetHeight * 0.2;
                    }
                }
            }
            
            // Calcola la direzione
            const dx = targetX - unit.x;
            const dy = targetY - unit.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            // Normalizza e applica la velocit√†
            if (distance > 0) {
                unit.x += (dx / distance) * unit.speed;
                unit.y += (dy / distance) * unit.speed;
            }
            
            // Aggiorna la posizione dell'elemento
            unit.element.style.left = unit.x + 'px';
            unit.element.style.top = unit.y + 'px';
        }

        function isUnitInRange(unit, target) {
            if (!target) return false;
            
            let targetX, targetY;
            
            if (target.type === 'unit') {
                targetX = target.object.x;
                targetY = target.object.y;
            } else {
                // Per le torri, usa una distanza fissa
                return Math.abs(unit.x - getTowerX(target.id, unit.player === 0 ? 1 : 0)) < 80 &&
                       Math.abs(unit.y - getTowerY(target.id, unit.player === 0 ? 1 : 0)) < 80;
            }
            
            const dx = unit.x - targetX;
            const dy = unit.y - targetY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            return distance < 50; // Raggio di attacco
        }

        function getTowerX(towerId, playerIndex) {
            if (playerIndex === 0) { // Giocatore 1 (in basso)
                if (towerId === 'king') return battlefield.offsetWidth * 0.45;
                if (towerId === 'left') return battlefield.offsetWidth * 0.2;
                return battlefield.offsetWidth * 0.7; // right
            } else { // Giocatore 2 (in alto)
                if (towerId === 'king') return battlefield.offsetWidth * 0.45;
                if (towerId === 'left') return battlefield.offsetWidth * 0.2;
                return battlefield.offsetWidth * 0.7; // right
            }
        }

        function getTowerY(towerId, playerIndex) {
            if (playerIndex === 0) { // Giocatore 1 (in basso)
                return battlefield.offsetHeight * 0.8;
            } else { // Giocatore 2 (in alto)
                return battlefield.offsetHeight * 0.2;
            }
        }

        function attackTarget(unit, target) {
            if (target.type === 'unit') {
                target.object.health -= unit.damage;
            } else { // tower
                target.object.health -= unit.damage / 10;
                updateTowerHealth();
            }
        }

        function checkWinConditions() {
            // Controlla se tutte le torri di un giocatore sono state distrutte
            const player1Towers = gameData.players[0].towers;
            const player2Towers = gameData.players[1].towers;
            
            const player1Alive = player1Towers.king.health > 0 || 
                                player1Towers.left.health > 0 || 
                                player1Towers.right.health > 0;
            
            const player2Alive = player2Towers.king.health > 0 || 
                                player2Towers.left.health > 0 || 
                                player2Towers.right.health > 0;
            
            if (!player1Alive) {
                endGame("player2");
                return;
            }
            
            if (!player2Alive) {
                endGame("player1");
                return;
            }
        }

        function endGame(reason) {
            clearInterval(gameInterval);
            gameData.gameState = "ended";
            
            // Determina il vincitore
            let winner;
            if (reason === "player1") {
                winner = gameData.players[0].name;
            } else if (reason === "player2") {
                winner = gameData.players[1].name;
            } else {
                // In caso di timeout, vince chi ha pi√π torri in vita
                const player1TowerCount = countAliveTowers(0);
                const player2TowerCount = countAliveTowers(1);
                
                if (player1TowerCount > player2TowerCount) {
                    winner = gameData.players[0].name;
                } else if (player2TowerCount > player1TowerCount) {
                    winner = gameData.players[1].name;
                } else {
                    // Se hanno lo stesso numero di torri, vince chi ha pi√π salute totale
                    const player1TotalHealth = calculateTotalTowerHealth(0);
                    const player2TotalHealth = calculateTotalTowerHealth(1);
                    
                    winner = player1TotalHealth > player2TotalHealth ? 
                        gameData.players[0].name : gameData.players[1].name;
                }
            }
            
            // Mostra il messaggio del vincitore
            winnerMessage.textContent = `${winner} ha vinto la partita!`;
            
            // Cambia schermata
            gameScreen.style.display = 'none';
            endScreen.style.display = 'block';
        }

        function countAliveTowers(playerIndex) {
            const towers = gameData.players[playerIndex].towers;
            let count = 0;
            
            if (towers.king.health > 0) count++;
            if (towers.left.health > 0) count++;
            if (towers.right.health > 0) count++;
            
            return count;
        }

        function calculateTotalTowerHealth(playerIndex) {
            const towers = gameData.players[playerIndex].towers;
            return towers.king.health + towers.left.health + towers.right.health;
        }

        function resetGame() {
            // Torna alla schermata iniziale
            endScreen.style.display = 'none';
            startScreen.style.display = 'block';
            
            // Pulisci il campo di battaglia
            const units = document.querySelectorAll('.unit');
            units.forEach(unit => unit.remove());
        }
    </script>
</body>
</html>